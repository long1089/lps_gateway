# IEC 60870-5-102 扩展指令与文件上报规范（网关实现基线）

��用范围
- 参考 DL/T 634.5102-2002（idt IEC 60870-5-102:2002），在网络环境下通过 TCP/IP（端口 3000）承载链路规约，扩展 ASDU 实现新能源“E 文件”传输与管理指令。
- 主站为启动端，子站（本网关）为从动端，采用 IEC 60870-5-2 非平衡链路传输规则。

关键不变式
- 小端序（低字节在前，高字节在后）。
- 链路地址与公共地址均为双字节，固定使用 0xFFFF（可兼容非 0xFFFF 的部署）。
- 可变帧 L 字段为“校验范围”的字节数，即从控制域（C）开始到数据区最后一个字节（含）止。
- 校验为逐字节累加取低 8 位（忽略进位）。

TCP 承载参数
- 传输层端口：3000
- 建议：启用 TCP keepalive，应用层心跳/保活由主站定期“请求链路状态”（FC=9）触发。

---

## 1. 链路层帧

固定帧（下行/上行确认与状态）
- 格式：10 C ALo AHi CHK 16
- 用途：复位、请求链路状态、召唤 1/2 级。

可变帧（带 ASDU 的用户数据）
- 格式：68 Llo Lhi 68 C ALo AHi [ASDU] CHK 16

控制域（C）位定义
- 主站→子站：PRM=1；FCB、FCV 按 IEC 规则切换；FC 见“下行功能码”。
- 子站→主站：PRM=0；ACD=1 表示有 1 级数据请求上送；DFC=1 表示缓冲区满。

下行功能码（主站→子站）
- 0：远方链路复位（FCV=0）
- 3：用户数据（FCV=1）
- 9：请求链路状态（FCV=0）
- 10：请求 1 级用户数据（FCV=1）
- 11：请求 2 级用户数据（FCV=1）

上行功能码（子站→主站）
- 0：肯定认可
- 1：否定认可（链路忙/未收到）
- 8：用户数据
- 9：无请求的数据
- 11：链路状态或要求访问（ACD 指示）

---

## 2. ASDU 一般结构

本扩展每帧仅承载一个 ASDU。

- TYP（1 字节）：类型标识
- VSQ（1 字节）：可变结构限定词，本规范固定为 0x01
- COT（1 字节）：传送原因（见下文）
- CAddr（2 字节）：公共地址（低字节、 高字节），固定 0xFFFF
- RAddr（1 字节）：记录地址，固定 0x00（保留）
- Data：数据区（随 TYP 变化）

校验范围
- 从 C（控制域）到 Data 的最后一个字节。

传送原因（COT）扩展（与文件传输相关）
- 0x07：本文件最后一帧（传输结束）
- 0x08：本文件非最后一帧（未结束）
- 0x0A：主站确认文件接收结束（下行）
- 0x0B：子站确认主站接收长度一致（成功，且处理该文件）
- 0x0C：子站确认主站接收长度不一致（失败，准备重传）
- 0x0D：主站确认子站重传文件（下行）
- 0x0E：子站确认文件重传（上行）
- 0x0F：主站认为文件过长（> 512×40 字节）
- 0x10：子站确认文件过长（并作其他处理）
- 0x11：主站认为文件名格式不正确
- 0x12：子站确认文件名格式不正确
- 0x13：主站认为单帧报文长度过长
- 0x14：子站确认单帧报文长度过长

备注
- 时间同步等控制类 COT 参照 IEC 101：0x06（激活）、0x07（激活确认）、0x0A（激活结束）。

---

## 3. 文件传输数据区定义

文件片段 ASDU（TYP=0x95–0xA8）
- 文件名：64 字节，ASCII/GBK，大写为主。短于 64 字节时以 0x00 填充；长于 64 字节视为“文件名格式不符合要求”。
- 文件内容片段：≤ 512 字节。
- 传输策略：每一帧均携带完整 64 字节文件名 + 片段数据，COT=0x08 表示后续还有片段；COT=0x07 表示本片段为最后一段。
- 重传策略：以“整文件”为粒度进行重传（不提供片段级重传）；主站下发 0x91（COT=0x0D）触发子站对同名文件重传。

关于“32 字节文件名”的兼容说明
- 文本 4.5.2 提及“32 个字节的文件名”，章节 7.x 定义为“64 字节”。本实现以 64 字节为标准。
- 兼容策略：若 L 长度与 32 字节布局吻合且后续帧一致，可容错接收；子站上送统一使用 64 字节文件名。

单帧长度限制与超长处理
- 数据区 2 ≤ 512 字节（片段）；当主站判定单帧过长，使用 TYP=0x94、COT=0x13，下行告知；子站以 TYP=0x94、COT=0x14 确认。
- 文件总长度上限：512×40= 20480 字节；超过则主站下发 TYP=0x92、COT=0x0F；子站以 TYP=0x92、COT=0x10 确认。

---

## 4. TYP 映射（文件类型）

| 序号 | 中文名称                   | 英文表名                  | TYP  |
|------|----------------------------|---------------------------|------|
| 1    | 风电场基础信息表           | EFJ_FARM_INFO             | 0x95 |
| 2    | 风电机组信息表             | EFJ_FARM_UNIT_INFO        | 0x96 |
| 3    | 风机运行表                 | EFJ_FARM_UNIT_RUN_STATE   | 0x97 |
| 4    | 单风场所有风机运行表       | EFJ_FARM_RUN_CAP          | 0x98 |
| 5    | 测风塔信息表               | EFJ_WIND_TOWER_INFO       | 0x99 |
| 6    | 测风塔采集数据表           | EFJ_FIVE_WIND_TOWER       | 0x9A |
| 7    | 场站上报短期预测           | EFJ_DQ_RESULT_UP          | 0x9B |
| 8    | 场站上报超短期预测         | EFJ_CDQ_RESULT_UP         | 0x9C |
| 9    | 场站上报日前计划           | EFJ_DQ_PLAN_UP            | 0xA6 |
| 10   | 场站上报天气预报           | EFJ_NWP_UP                | 0x9D |
| 11   | 场站上报其他信息           | EFJ_OTHER_UP              | 0x9E |
| 12   | 场站上报理论功率           | EFJ_FIF_THEORY_POWER      | 0x9F |
| 13   | 光伏电站基础信息表         | EGF_GF_INFO               | 0xA4 |
| 14   | 光伏气象站信息表           | EGF_GF_QXZ_INFO           | 0xA0 |
| 15   | 光伏逆变器信息表           | EGF_GF_UNIT_INFO          | 0xA3 |
| 16   | 逆变器运行表               | EGF_GF_UNIT_RUN_STATE     | 0xA2 |
| 17   | 气象站采集数据表           | EGF_FIVE_GF_QXZ           | 0xA1 |
| 18   | 风电场实时数据             | EFJ_REALTIME              | 0xA7 |
| 19   | 光伏电站实时数据           | EGF_REALTIME              | 0xA8 |

控制/确认类（主站↔子站）
- 0x90：文件传输结束确认/对账（含文件长度 4 字节）
- 0x91：文件重传控制
- 0x92：文件过长控制
- 0x93：文件名格式错误控制
- 0x94：单帧报文过长控制

数据分级（用于 ACD/召唤）
- 1 级：短期预测（0x9B）、超短期预测（0x9C）、天气预报（0x9D）、测风塔采集（0x9A）、光伏气象站采集（0xA1）。
- 2 级：其余类型。

---

## 5. 扩展指令 ASDU（时间同步、文件点播）

### 5.1 时间同步（TYP=0x8B）

- 方向：主站→子站（请求），子站→主站（确认/结束）
- COT：0x06 激活、0x07 激活确认、0x0A 激活结束
- Data：CP56Time2a（7B，UTC）

### 5.2 文件点播请求（TYP=0x8D）

- 方向：主站→子站
- COT：0x06 激活（请求）、0x07 激活确认（可选）、0x0A 激活结束（发送完毕/失败）
- Data：
  - Byte0：ReportTypeCode（1–19）
  - Byte1：Mode（bit0=0 最新；bit0=1 时间范围；bit1=1 压缩保留）
  - 若范围模式：Start CP56Time2a（7B） + End CP56Time2a（7B）
  - 否则：RefTime CP56Time2a（7B），用于路径模板解析

### 5.3 文件点播取消（TYP=0x8E）

- 方向：主站→子站
- COT：0x06 激活
- Data：
  - Byte0：ReportTypeCode（1–19）
  - Byte1：取消范围（0=全部；1=仅未开始；2=仅进行中）

---

## 6. 交互流程（概要）

初始化
1) 主站：请求链路状态（FC=9）→ 子站：链路状态响应（FC=11）
2) 主站：复位（FC=0）→ 子站：肯定认可（FC=0）

正常通信（2 级召唤例）
1) 主站：召唤 2 级（FC=11）
2) 子站：上送文件帧（TYP=0x95..0xA8，COT=0x08/0x07）
3) 文件结束：对账（TYP=0x90，长度 4B）与确认流程

重传
- 主站下发 TYP=0x91、COT=0x0D → 子站 TYP=0x91、COT=0x0E 并重传

时间同步
- 主站 TYP=0x8B、COT=0x06 → 子站 0x07/0x0A

点播文件
- 主站 TYP=0x8D、COT=0x06 → 子站依序发送对应 TYP 文件帧 → TYP=0x8D、COT=0x0A 结束

---

## 7. 长度与校验

- L = 1(C) + 2(ALo,AHi) + [1(TYP)+1(VSQ)+1(COT)+2(CAddr)+1(RAddr)+Data(n)]
- 文件帧 n = 64(文件名)+k(≤512)
- 校验：从 C 到 Data 末的逐字节相加取低 8 位

---

## 8. 实施建议与日志

- 每会话一次仅传输一个文件，避免片段交织。
- 协议日志：帧 HEX、TYP、COT、长度、校验；文件统计：片段数、重传次数、耗时。
- 若需压缩，建议文件级 gzip（文件名后缀 .GZ），不改变分段上限.