# M6 实现指南：集成与测试

## 概述

M6 里程碑是项目的最后阶段，专注于系统集成测试、性能测试、容灾测试和文档完善。本阶段确保系统在生产环境中的稳定性、可靠性和性能。

## 目标

1. **主站集成测试**：验证与实际主站的完整通讯流程
2. **性能测试**：评估系统在高负载下的表现
3. **容灾测试**：验证系统的容错和恢复能力
4. **文档完善**：提供完整的部署和运维文档

## 测试范围

### 1. 集成测试 (Integration Testing)

#### 1.1 主站通讯测试

**测试目标**：验证 IEC-102 协议完整通讯流程

**测试场景**：
- TCP 连接建立和链路初始化
- 时间同步 (TYP=0x8B)
- 文件点播 (TYP=0x8D) 和取消 (TYP=0x8E)
- 单帧文件传输 (TYP=0x95-0xA8)
- 多帧文件传输和重组
- 对账和确认 (TYP=0x90-0x94)
- 1级数据自动上送 (ACD标志)
- 2级数据召唤上送

**验证要点**：
- 帧格式正确性（0x10/0x68 帧结构）
- FCB/FCV 序列号正确
- 校验和验证通过
- 超时重传机制
- 文件完整性（MD5/大小）

#### 1.2 端到端工作流测试

**测试场景**：
1. SFTP 下载 -> 文件存储 -> 文件记录持久化
2. 客户端连接 -> 任务初始化 -> 文件分段传输
3. 传输完成 -> 对账 -> 状态更新
4. 审计日志记录 -> 仪表盘显示

**验证要点**：
- 数据流完整性
- 状态转换正确
- 事务一致性
- 日志完整性

#### 1.3 多客户端并发测试

**测试场景**：
- 多个主站同时连接
- 不同数据类型并发传输
- 1级和2级数据混合传输

**验证要点**：
- 连接隔离
- 数据不混淆
- 并发安全

### 2. 性能测试 (Performance Testing)

#### 2.1 并发连接测试

**测试目标**：评估系统支持的最大并发连接数

**测试方法**：
- 逐步增加并发客户端数量
- 监控 CPU、内存、网络使用率
- 记录响应时间和错误率

**性能基准**：
- 目标：支持 ≥50 并发连接
- 响应时间：< 500ms (P95)
- 错误率：< 0.1%

#### 2.2 吞吐量测试

**测试目标**：评估文件传输吞吐量

**测试方法**：
- 传输不同大小的文件（1KB - 20MB）
- 测量传输速率和完成时间
- 监控网络带宽利用率

**性能基准**：
- 小文件 (< 100KB)：> 1000 文件/分钟
- 大文件 (> 1MB)：> 10 MB/s
- 网络利用率：< 80%

#### 2.3 数据库性能测试

**测试目标**：评估数据库读写性能

**测试方法**：
- 批量插入文件记录
- 并发查询测试
- 长时间运行稳定性测试

**性能基准**：
- 插入速率：> 1000 条/秒
- 查询响应：< 100ms (P95)
- 数据库连接池：稳定在 10-20 连接

#### 2.4 内存和资源使用测试

**测试目标**：评估系统资源占用

**测试方法**：
- 长时间运行测试（24小时）
- 监控内存泄漏
- 监控文件句柄和线程数

**性能基准**：
- 内存使用：< 2GB (稳态)
- 无内存泄漏
- 文件句柄：< 1000
- 线程数：< 100

### 3. 容灾测试 (Disaster Recovery Testing)

#### 3.1 SFTP 故障恢复测试

**测试场景**：
1. SFTP 连接超时
2. SFTP 服务器重启
3. 网络间歇性中断
4. 认证失败

**验证要点**：
- 自动重试机制
- 错误日志记录
- 状态回滚正确
- 任务可重放

#### 3.2 TCP 会话故障测试

**测试场景**：
1. 客户端突然断开
2. 传输中网络中断
3. 服务器重启
4. 超时未响应

**验证要点**：
- 会话清理正确
- 部分传输文件处理
- 重连后可恢复
- 无数据丢失

#### 3.3 数据库故障测试

**测试场景**：
1. 数据库连接断开
2. 事务失败回滚
3. 磁盘满
4. 数据库重启

**验证要点**：
- 连接重试机制
- 事务一致性
- 错误处理优雅
- 数据完整性

#### 3.4 任务重放测试

**测试场景**：
1. 下载任务失败后重试
2. 传输任务中断后恢复
3. 重复任务去重

**验证要点**：
- 任务状态正确
- 幂等性保证
- 无重复数据
- 审计日志完整

### 4. 压力测试 (Stress Testing)

#### 4.1 峰值负载测试

**测试目标**：找到系统的性能极限

**测试方法**：
- 持续增加负载直到系统失败
- 记录失败点和失败模式
- 分析瓶颈

#### 4.2 长时间稳定性测试

**测试目标**：验证系统长期运行稳定性

**测试方法**：
- 连续运行 72 小时
- 模拟真实负载模式
- 监控所有指标

### 5. 安全测试 (Security Testing)

#### 5.1 认证和授权测试

**测试场景**：
- 未认证访问拦截
- 权限边界测试
- 密码加密验证
- 会话管理测试

#### 5.2 输入验证测试

**测试场景**：
- SQL 注入测试
- 路径遍历测试
- 文件上传限制测试
- 协议畸形帧测试

## 测试工具和脚本

### 1. 集成测试脚本

```bash
# tests/IntegrationTests/run_integration_tests.sh
#!/bin/bash

# 启动数据库
docker-compose up -d postgres

# 启动服务
cd src && dotnet run &
SERVICE_PID=$!

# 等待服务就绪
sleep 10

# 运行集成测试
cd ../tests
dotnet test --filter "Category=Integration"

# 清理
kill $SERVICE_PID
docker-compose down
```

### 2. 性能测试脚本

```bash
# tests/PerformanceTests/run_performance_tests.sh
#!/bin/bash

# 设置测试参数
CONCURRENT_CLIENTS=50
TEST_DURATION=300  # 5分钟
FILE_SIZE=1048576  # 1MB

# 运行性能测试
dotnet test --filter "Category=Performance" \
  -- TestRunParameters.Parameter\(name=\"ConcurrentClients\",value=\"$CONCURRENT_CLIENTS\"\)
```

### 3. 压力测试工具

使用现有的 MasterSimulator 创建压力测试版本：

```csharp
// tools/StressTestSimulator/Program.cs
// 多线程模拟多个主站并发连接和传输
```

## 测试数据准备

### 1. 测试文件集

创建各种大小和格式的测试 E 文件：
- 小文件：1KB - 10KB (快速测试)
- 中文件：100KB - 1MB (常规场景)
- 大文件：5MB - 20MB (压力测试)
- 特殊字符文件名测试
- GBK 编码内容测试

### 2. 数据库测试数据

预填充数据库：
- 1000+ 文件记录
- 100+ SFTP 配置
- 50+ 报表类型
- 审计日志数据

## 监控和指标收集

### 1. 性能指标

**系统指标**：
- CPU 使用率（总体和每核）
- 内存使用量（RSS、堆）
- 磁盘 I/O（读写速率、IOPS）
- 网络流量（接收/发送速率）

**应用指标**：
- TCP 连接数（活跃/总数）
- 请求速率（请求/秒）
- 响应时间（平均、P50、P95、P99）
- 错误率（按类型）
- 队列长度（任务队列）

**业务指标**：
- 文件传输成功率
- SFTP 下载成功率
- 平均传输时间
- 文件大小分布

### 2. 日志收集

**日志级别**：
- Error：错误和异常
- Warning：告警和非预期情况
- Information：关键业务事件
- Debug：详细调试信息（仅测试环境）

**日志内容**：
- 时间戳、级别、来源
- 请求 ID（追踪）
- 关键业务参数
- 错误堆栈

### 3. 监控工具

推荐工具栈：
- Prometheus：指标收集
- Grafana：可视化仪表盘
- ELK Stack：日志聚合和分析
- dotnet-counters：实时性能监控

## 测试环境

### 1. 硬件配置

**最低配置**：
- CPU：4 核
- 内存：8 GB
- 磁盘：100 GB SSD
- 网络：1 Gbps

**推荐配置**：
- CPU：8 核
- 内存：16 GB
- 磁盘：500 GB SSD
- 网络：10 Gbps

### 2. 软件配置

**操作系统**：
- Ubuntu 22.04 LTS 或 CentOS 8
- Windows Server 2022

**依赖服务**：
- .NET 8 Runtime
- PostgreSQL 15 或 OpenGauss 5.0
- Docker 24+

## 测试执行计划

### 第 1-2 天：集成测试

- [ ] 环境准备和工具验证
- [ ] 主站通讯测试
- [ ] 端到端工作流测试
- [ ] 多客户端测试
- [ ] 问题修复和回归测试

### 第 3-4 天：性能测试

- [ ] 基准性能测试
- [ ] 并发连接测试
- [ ] 吞吐量测试
- [ ] 数据库性能测试
- [ ] 性能调优

### 第 5 天：容灾测试

- [ ] 故障注入测试
- [ ] 恢复流程验证
- [ ] 数据一致性检查
- [ ] 容灾方案优化

### 第 6 天：压力测试和安全测试

- [ ] 峰值负载测试
- [ ] 长时间稳定性测试
- [ ] 安全漏洞扫描
- [ ] 渗透测试

### 第 7 天：文档和总结

- [ ] 测试报告编写
- [ ] 运维文档完善
- [ ] 问题清单整理
- [ ] 发布准备

## 问题跟踪

### 问题分级

**P0 - 阻断性问题**：
- 系统崩溃或无法启动
- 数据丢失或损坏
- 严重安全漏洞

**P1 - 严重问题**：
- 核心功能不可用
- 性能严重下降
- 频繁错误

**P2 - 一般问题**：
- 次要功能异常
- 性能不达标
- 用户体验问题

**P3 - 优化建议**：
- 代码质量改进
- 性能优化建议
- 功能增强建议

## 验收标准

### 功能完整性

- [ ] 所有 M1-M5 功能正常工作
- [ ] 无 P0/P1 级别问题
- [ ] 集成测试 100% 通过

### 性能要求

- [ ] 支持 ≥50 并发连接
- [ ] 文件传输吞吐量 ≥10 MB/s
- [ ] P95 响应时间 < 500ms
- [ ] 错误率 < 0.1%

### 稳定性要求

- [ ] 72 小时稳定运行
- [ ] 无内存泄漏
- [ ] 无资源耗尽
- [ ] 故障恢复正常

### 文档完整性

- [ ] 部署文档完整
- [ ] 运维手册详细
- [ ] API 文档准确
- [ ] 故障排查指南清晰

## 测试交付物

1. **测试计划**：本文档
2. **测试脚本**：自动化测试代码
3. **测试报告**：详细测试结果
4. **性能报告**：性能指标和瓶颈分析
5. **问题清单**：发现的问题和修复状态
6. **运维文档**：部署和运维指南
7. **发布说明**：版本特性和已知问题

## 后续改进建议

### 自动化改进

- [ ] CI/CD 集成自动化测试
- [ ] 性能回归测试自动化
- [ ] 部署自动化脚本

### 监控改进

- [ ] 实时告警系统
- [ ] 自动化故障恢复
- [ ] APM 集成

### 文档改进

- [ ] 视频教程
- [ ] 交互式文档
- [ ] 常见问题 FAQ

## 参考资料

- [Architecture-Design.md](Architecture-Design.md) - 架构设计文档
- [IEC102-Extended-Doc.md](IEC102-Extended-Doc.md) - 协议规范
- [M1-M5 实现指南] - 前期里程碑文档
- IEC 60870-5-102 标准
- .NET 性能测试最佳实践

---

**文档版本**：1.0
**创建时间**：2024-11
**维护者**：LPS Gateway Team
